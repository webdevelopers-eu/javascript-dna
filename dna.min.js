/*! Javascript DNA v1.0 | (c) Daniel Ševčík | www.webdevelopers.eu | MIT license | https://github.com/webdevelopers-eu/javascript-dna */
"use strict";if("function"!=typeof jQuery)throw new Error("DNA requires jQuery");!function($,window){function DNACore(){this.waiting=[],this.configs=[],this.resources={}}function getOptsCategorize(e,r,t){var n=[$.type(e)];return $.isPlainObject(e)&&n.push("plainObject"),$.isNumeric(e)&&n.push("numeric"),$.isXMLDoc(e)&&n.push("xmlDocument"),r.some(function(i,o){var a=r[o].match.some(function(r){return getOptsMatch(e,r,n)},this);return a?(r[o].recursive?$.isPlainObject(e)?$.each(e,function(e,r){t[e]||(t[e]=[]),t[e].push(r)}):$.each(e,function(e,n){getOptsCategorize(n,r,t)}.bind(this)):t[r[o].name].push(e),!0):!1},this)}function getOptsMatch(e,r,t){switch(typeof r){case"function":return r(e);case"object":return-1!==$.inArray("string",t)&&r.test(e);case"string":return"*"==r||-1!==$.inArray(r,t);default:$.error('Cannot parse opts. Unexpected match type "'+typeof r+'"')}return!1}function requireMulti(e,r){var t=[];try{this.getOpts(e,[["names","string"],"recursive"]).names.forEach(function(e){t.push(requireSingle.call(this,e,r))}.bind(this))}catch(e){return $.Deferred().reject(new DNAError(e)).promise()}return $.when.apply(this,t)}function requireSingle(e,r){var t,n=[],i=$.Deferred();return-1!=$.inArray(e,r)&&$.error("DNA: Recursive requirement: "+r.join(" > ")+" > "+e+" (recursion)"),r.push(e),t=dna.core.getConfig(e),t||$.error('DNA: Cannot satisfy the requirement "'+e+'"'),t._dfd?t._dfd:(t._dfd=i.promise(),n.push(this.load(t,t.load||[])),n.push(requireMulti.call(this,[t.require],r)),$.when.apply(this,n).done(function(r){var n;evaluateScripts(r).done(function(r){t.proto[0]&&(r?$.each(t.proto.slice(t.proto.length>1?1:0),function(e,t){dna[t]=r}):i.reject(new DNAError('DNA: Cannot find the Proto object window["'+t.proto+'"]: '+JSON.stringify(t),602,{config:t}))),r&&t.service&&(dna[t.service]=new r),t.id==e?n=t:dna[e]&&(n=dna[e]),n?i.resolve(n):i.reject(new DNAError('DNA: Cannot find the requested object dna["'+e+'"]: '+JSON.stringify(t),603,{config:t}))}).fail(function(){i.reject.apply(this,arguments)})}).fail(function(){i.reject.apply(this,arguments)}),t._dfd)}function evaluateScripts(e){function r(i){if(!i)return e.length?n.reject(new DNAError("Scripts queue is not empty and we got no data!",607,{script:i,queue:e})):n.resolve(t);var o=$.Deferred().done(function(n){t=n||t,r(e.shift())}).fail(function(){n.reject.apply(this,arguments)}),a=settings.factory[i.config.eval||"dna"];if("function"!=typeof a)return o.reject(new DNAError('Unknown evaluation type "'+i.config.eval+'"',604,i));try{a(i.jString,i.config.proto[0],o)}catch(e){return o.reject(new DNAError(e))}return o}var t,n=$.Deferred();return r(e.shift()),n}function loadGetResource(e){var r,t=$.Deferred(),n=e.split("#");return r=function(r){if(1==n.length)return void t.resolve(r+" //# sourceURL="+e+"#dna");var i=document.implementation.createHTMLDocument("html","","");i.childNodes[1].innerHTML=r;var o=$("#"+n[1],i),a=$.trim(o.text());if(a.length)t.resolve(a+" //# sourceURL="+e);else if(o.attr("src")){var s=o.get(0).src||o.attr("src")||o.get(0).href||o.attr("href");s?loadGetResource(dna.core.resolveURL(s,e)).done(function(){t.resolve.apply(this,arguments)}).fail(function(){t.reject.apply(this,arguments)}):t.reject(new DNAError('The script "'+e+'" has no contents and no reference to other external resource.',605,{script:o.get(0),source:r,url:e}))}else t.reject(404,'Cannot load script "'+e+'"')},download(n[0],"text").done(r).fail(function(){t.reject.apply(this,arguments)}),t}function validateString(e,r,t){return e&&r.test(e)||$.error("DNA: "+t+" String "+JSON.stringify(e)+" does not match the pattern "+r),!0}function download(e,r){if(dna.core.resources[e])return dna.core.resources[e];var t=$.Deferred();return dna.core.resources[e]=t.promise(),$.ajax({url:e,dataType:r||"text",cache:!0,type:"GET",async:!0}).done(function(e){t.resolve(e)}).fail(function(r,n,i){t.reject.call(this,new DNAError('Download "'+e+'" failed: '+r.status+" "+n+" "+i,606,{xhr:r,textStatus:n,error:i}))}),dna.core.resources[e]}function DNAError(e,r,t){e instanceof Error?(this.name=e.name||"DNAError",this.message=e.message||"Unknown Error.",this.code=e.code||700,this.detail=e.detail||e):(this.name="DNAError",this.message=e||"Ups!",this.code=r||700,this.detail=t),this.stack=(new Error).stack,console.log("DNAError: "+this.code+" "+e,t,this.stack)}var settings={factory:{window:function(e,r,t){r=r?'window["'+r+'"]':"undefined";var n="typeof "+r+" == 'undefined' ? undefined : "+r;t.resolve(window.eval(e+"\n\n/* Javascript DNA: Compat Layer */;\n"+n))},dna:function(jString,protoName,dfd){protoName=protoName?protoName:"undefined";var retStatement="typeof "+protoName+" == 'undefined' ? undefined : "+protoName;dfd.resolve(eval(jString+"\n\n/* Javascript DNA: Compat Layer */;\n"+retStatement))}}},dna=function(){var e=arguments,r=$.Deferred().done(function(){$(window).trigger("dna:done",[{dnaArguments:e,arguments:arguments}])}).fail(function(){$(window).trigger("dna:fail",[{dnaArguments:e,arguments:arguments}])}).always(function(){$(window).trigger("dna:always",[{dnaArguments:e,arguments:arguments}])}),t=function(){r.reject.apply(this,arguments)},n=dna.core.getOpts(arguments,[{recursive:!0,match:"array"},["jsonURLs",/[.\/]/],["required","string"],["settings",function(e){return $.isPlainObject(e)&&!e.proto&&!e.id}],["configs","plainObject"],["callbacks","function"]]);if(n.settings.forEach(dna.core.set),n.jsonURLs.length+n.required.length+n.configs.length==0)return r.resolve().done(n.callbacks).promise();try{n.configs.forEach(dna.core.configure.bind(dna.core)),$.when.apply(this,n.jsonURLs.map(download)).done(function(){var e=$.makeArray(arguments).map(function(e,r){return dna.core.getOpts($.parseJSON(e),[["configs","plainObject"],"recursive"]).configs.map(function(e){return e.baseURL=n.jsonURLs[r],e})});dna(e).done(function(){dna.core.whenSatisfied(n.required).done(function(){$.when.apply(this,n.required.map(function(e){return dna.core.require(e)})).done(n.callbacks,function(){r.resolve.apply(this,arguments)}).fail(t)}).fail(t)}).fail(t)}).fail(t)}catch(e){r.reject(new DNAError(e))}return r.promise()};dna.push=function(){return dna.apply(this,arguments),dna.core.waiting.length},DNACore.prototype.version="1.0",DNACore.prototype.waiting=null,DNACore.prototype.configs=null,DNACore.prototype.resources=null,DNACore.prototype.resolveURL=function(){for(var e=document.implementation.createHTMLDocument("html","",""),r=e.head.appendChild(e.createElement("base")),t=e.body.appendChild(e.createElement("a")),n=location?location.href:"https://example.com/",i=arguments.length-1;i>=0;i--)r.setAttribute("href",n),t.setAttribute("href",arguments[i]),n=t.href;return n},DNACore.prototype.set=function(e){$.each(e,function(e,r){switch(e){case"factory":delete r.dna,delete r.window,settings[e]=$.extend(settings[e],r);break;default:settings[e]=r}}),console.log("DNA: Settings altered.",settings)},DNACore.prototype.configure=function(e){var r=!1;e=$.extend({},e),e.id&&(r=validateString(e.id,/^[a-z0-9:_-]+$/i,"Invalid `id` name in "+JSON.stringify(e)+".")),e.service&&(r=validateString(e.service,/^[a-z][a-zA-Z0-9_]+$/,"Invalid `service` name in "+JSON.stringify(e)+".")),e.proto&&(r=validateString(e.proto,/^[A-Z][a-zA-Z0-9_:=]+$/,"Invalid `proto` name in "+JSON.stringify(e)+".")),r||$.error("At least one must be specified `id` or `service` or `proto` in Config "+JSON.stringify(e)),e.service&&!e.proto&&$.error('Service "'+e.service+'" requires the `proto` property: '+JSON.stringify(e)),delete e._dfd,e.proto=e.proto?e.proto.split("="):[],[e.id,e.service].concat(e.proto.slice(e.proto.length>1?1:0)).forEach(function(r){r&&("undefined"==typeof dna[r]?dna[r]=null:$.error("DNA: Conflicting name `"+r+"` / redundand Config registration while registering config: "+JSON.stringify(e)+"; conflicting config exists: "+JSON.stringify(dna.core.getConfig(r))+". Note: All `id`, `proto` and `service` names must be unique accross the board."))}),this.configs.push(e)},DNACore.prototype.canSatisfy=function(e,r){if("undefined"==typeof e||0==e.length)return!0;r=r||[];for(var t in e){if(-1!==$.inArray(e[t],r))throw new DNAError("DNA: Recursive requirement loop: "+r.join(" > ")+" > "+e[t],601,{requirements:e,stack:r});var n=this.getConfig(e[t]);if(!n)return!1;var i=r.slice();if(i.push(e[t]),!this.canSatisfy(n.require,i))return!1}return!0},DNACore.prototype.whenSatisfied=function(){var e=$.Deferred(),r=this.getOpts(arguments,[["requirements","string"],["callbacks","function"],"recursive"]);r._dfd=e,this.waiting.push(r);for(var t=this.waiting.length-1;t>=0;t--){var n=this.waiting[t];try{var i=this.canSatisfy(n.requirements)}catch(e){this.waiting.splice(t,1),n._dfd.reject(new DNAError(e));break}i?(this.waiting.splice(t,1),$(n.callbacks).each(function(e,r){r()}),n._dfd.resolve(n)):console.log("DNA: Queued action #"+(t+1)+"/"+this.waiting.length+": Waiting for yet undefined requirements: "+n.requirements.join(", "))}return e},DNACore.prototype.getConfig=function(e){for(var r=0;r<this.configs.length;r++){var t=this.configs[r];if(t.id==e||t.service==e||-1!==$.inArray(e,t.proto,t.proto.length>1?1:0))return t.baseURL&&(t.load=dna.core.getOpts(t.load,[["urls","string"],"recursive"]).urls.map(function(e){return dna.core.resolveURL(e,t.baseURL)}),delete t.baseURL),"string"==$.type(t.require)&&(t.require=[t.require]),"string"==$.type(t.load)&&(t.load=[t.load]),t}return null},DNACore.prototype.getOpts=function(e,r){var t={};return r.forEach(function(e,n){"recursive"==r[n]&&(r[n]={match:"*",recursive:!0}),$.isArray(r[n])&&(r[n]={name:r[n][0],match:r[n][1]}),"object"!=typeof r[n]&&$.error("Capture item must be of type object or array."),$.isArray(r[n].match)||(r[n].match=[r[n].match]),r[n].recursive||(t[r[n].name]=[])}),$.each($.makeArray(e),function(e,n){getOptsCategorize(n,r,t)||$.error("Unexpected opt ("+typeof n+") "+n)}.bind(this)),t},DNACore.prototype.require=function(){return requireMulti.call(this,$.makeArray(arguments),[])},DNACore.prototype.load=function(e,r){r=this.getOpts(r,[["urls","string"],"recursive"]).urls;var t=[];r.forEach(function(e){t.push(loadGetResource(e))});var n=$.Deferred();return $.when.apply(this,t).done(function(){for(var r=[],t=0;t<arguments.length;t++)r.push({jString:arguments[t],config:e});n.resolve(r)}).fail(function(){n.reject.apply(this,arguments)}),n},DNAError.prototype=Object.create(Error.prototype),DNAError.prototype.constructor=DNAError,dna.DNACore=DNACore,dna.core=new DNACore,console.log("DNA: Ready.");var queue=window.dna||[];window.dna=dna;for(var i=0;i<queue.length;i++)window.dna.apply(this,[queue[i]])}(jQuery,window);
//# sourceMappingURL=dna.min.map