/**
 * Javascript DNA 1.0
 *
 * Minimalistic asynchronous script loader, dependency resolver and
 * framework base. No bullshits.
 *
 * @license The MIT License (MIT), https://github.com/webdevelopers-eu/javascript-dna
 * @preserve Copyright (c) 2016 Daniel Ševčík, www.webdevelopers.eu
 */
"use strict";if("function"!=typeof jQuery)throw new Error("DNA requires jQuery");!function($,window){function DNACore(){this.queue=[],this.configs=[],this.resources={}}function getOptsCategorize(e,r,n){var t=[$.type(e)];return $.isPlainObject(e)&&t.push("plainObject"),$.isNumeric(e)&&t.push("numeric"),$.isXMLDoc(e)&&t.push("xmlDocument"),r.some(function(i,o){var a=r[o].match.some(function(r){return getOptsMatch(e,r,t)},this);return a?(r[o].recursive?$.isPlainObject(e)?$.each(e,function(e,r){n[e]||(n[e]=[]),n[e].push(r)}):$.each(e,function(e,t){getOptsCategorize(t,r,n)}.bind(this)):n[r[o].name].push(e),!0):!1},this)}function getOptsMatch(e,r,n){switch(typeof r){case"function":return r(e);case"object":return-1!==$.inArray("string",n)&&r.test(e);case"string":return"*"==r||-1!==$.inArray(r,n);default:$.error('Cannot parse opts. Unexpected match type "'+typeof r+'"')}return!1}function requireMulti(e,r){var n=[];try{dna["dna:core"].getOpts(e,[["names","string"],"recursive"]).names.forEach(function(e){n.push(requireSingle.call(this,e,r))}.bind(this))}catch(e){return $.Deferred().reject(new DNAError(e)).promise()}return $.when.apply(this,n)}function requireSingle(e,r){var n,t=[],i=$.Deferred();return-1!=$.inArray(e,r)&&$.error("DNA: Recursive requirement: "+r.join(" > ")+" > "+e+" (recursion)"),r.push(e),n=dna["dna:core"].getConfig(e),n||$.error('DNA: Cannot satisfy the requirement "'+e+'"'),n._dfd?n._dfd:(n._dfd=i.promise(),t.push(fetchResources(n)),t.push(requireMulti.call(this,[n.require],r)),$.when.apply(this,t).done(function(r){var t;evaluateScripts(r,n).done(function(r){n.proto[0]&&(r?$.each(n.proto.slice(n.proto.length>1?1:0),function(e,n){dna[n]=r}):i.reject(new DNAError('DNA: Cannot find the Proto object window["'+n.proto+'"]: '+JSON.stringify(n),602,{config:n}))),r&&n.service&&(dna[n.service]=new r),n.id==e?t=n:dna[e]&&(t=dna[e]),t?i.resolve(t):i.reject(new DNAError('DNA: Cannot find the requested object dna["'+e+'"]: '+JSON.stringify(n),603,{config:n}))}).fail(function(){i.reject.apply(this,arguments)})}).fail(function(){i.reject.apply(this,arguments)}),n._dfd)}function fetchResources(e){var r=dna["dna:core"].getOpts(e.load,[["urls","string"],"recursive"]).urls,n=[];r.forEach(function(r){n.push(loadGetResource(r,e))});var t=$.Deferred();return $.when.apply(this,n).done(function(){for(var e=[],r=0;r<arguments.length;r++)e.push(arguments[r]);t.resolve(e)}).fail(function(){t.reject.apply(this,arguments)}),t}function evaluateScripts(e,r){function n(o){if(!o)return e.length?i.reject(new DNAError("Scripts queue is not empty and we got no data!",607,{script:o,queue:e})):i.resolve(t);var a=settings.factory[r.eval||"dna"],s=$.Deferred().done(function(r){t=r||t,n(e.shift())}).fail(function(){i.reject(new DNAError("Evaluation of the script failed.",608,{arguments:arguments,about:o}))});if("function"!=typeof a)return s.reject(new DNAError('Unknown evaluation type "'+r.eval+'"',604,r));try{a(s,o,r.proto[0],r)}catch(e){return s.reject(new DNAError(e))}return s}var t,i=$.Deferred();return n(e.shift()),i}function loadGetResource(e,r){var n,t=$.Deferred(),i=e.split("#");return n=function(n){if(1==i.length)return void t.resolve(n+" //# sourceURL="+e+"#dna");var o=document.implementation.createHTMLDocument("html","","");o.childNodes[1].innerHTML=n;try{var a=$("#"+i[1],o);if(!a.length)throw'Bundled resource "#'+i[1]+'" not found in "'+e+'"'}catch(r){return void t.reject(new DNAError('Cannot extract resource "#'+i[1]+'" from bundle "'+e+": "+(r.message||r),609,r))}var s=$.trim(a.text());if(s.length)t.resolve(s+" //# sourceURL="+e);else if(a.attr("src")){var c=a.get(0).src||a.attr("src")||a.get(0).href||a.attr("href");c?loadGetResource(dna["dna:core"].resolveURL(c,e),r).done(function(){t.resolve.apply(this,arguments)}).fail(function(){t.reject.apply(this,arguments)}):t.reject(new DNAError('The script "'+e+'" has no contents and no reference to other external resource.',605,{script:a.get(0),source:n,url:e}))}else t.reject(404,'Cannot load script "'+e+'"')},download(i[0],r).done(n).fail(function(){t.reject.apply(this,arguments)}),t}function validateString(e,r,n){return e&&r.test(e)||$.error("DNA: "+n+" String "+JSON.stringify(e)+" does not match the pattern "+r),!0}function download(e,r){if(dna["dna:core"].resources[e])return dna["dna:core"].resources[e];var n=$.Deferred();dna["dna:core"].resources[e]=n.promise();var t=e.match(/^([a-z][a-z0-9+.-]*):/i)[1];return n.fail(function(e){new DNAError(e)}),settings.fetcher[t]&&settings.fetcher[t](n,e,r)!==!1||settings.fetcher["*"](n,e,r),dna["dna:core"].resources[e]}function rewriteURL(e,r){var n=e;return settings.rewrite.forEach(function(r){e=r(e,n)||e}),e=dna["dna:core"].resolveURL(e,r)}function cleanConfigFast(e){return delete e._clean,e.proto=e.proto?e.proto.split("="):[],e}function readyConfig(config){return config._ready?config:(delete config._dfd,config.load=dna["dna:core"].getOpts(config.load,[["urls","string"],"recursive"]).urls.map(function(e){return rewriteURL(e,config.baseURL)}),"array"!==$.type(config.require)&&(config.require=config.require?[config.require]:[]),"array"!==$.type(config.load)&&(config.load=config.load?[config.load]:[]),config.namespace=config.namespace+""||!1,"window"==config.namespace?(dna["dna:namespaces"][config.namespace]=dna["dna:namespaces"][config.namespace]||function(e){return window.eval(e)},config._namespace=dna["dna:namespaces"][config.namespace]):config.namespace?(dna["dna:namespaces"][config.namespace]=dna["dna:namespaces"][config.namespace]||function(jString){return eval(jString)},config._namespace=dna["dna:namespaces"][config.namespace]):config._namespace=function(jString){return eval(jString)},config._ready=!0,config)}function DNAError(e,r,n){e instanceof Error?(this.name=e.name||"DNAError",this.message=e.message||"Unknown Error.",this.code=e.code||700,this.detail=e.detail||e):(this.name="DNAError",this.message=e||"Ups!",this.code=r||700,this.detail=n),this.stack=(new Error).stack,console.log("DNAError: "+this.code+" "+e,n,this.stack)}var settings={rewrite:[],fetcher:{"*":function(e,r,n){return $.ajax({url:r,dataType:"text",cache:!0,type:"GET",async:!0,headers:{"X-Requested-With":"DNA"}}).done(function(r){e.resolve(r)}).fail(function(t,i,o){e.reject.call(this,new DNAError('Download "'+r+'" failed: '+t.status+" "+i+" "+o,606,{config:n,xhr:t,textStatus:i,error:o}))}),!0}},factory:{dna:function(e,r,n,t){n=n?n:"undefined";var i=r+"\n\n/* Javascript DNA: Compat Layer */;\ntypeof "+n+" == 'undefined' ? undefined : "+n;try{e.resolve(t._namespace(i))}catch(r){throw e.reject(new DNAError("Failed to evaluate the script: "+(r.message||r),610,{jString:i,arguments:arguments,exception:r,config:t})),r}}}},dna=function(){var e=arguments,r=$.Deferred().done(function(){$(window).trigger("dna:done",[{dnaArguments:e,arguments:arguments}])}).fail(function(){$(window).trigger("dna:fail",[{dnaArguments:e,arguments:arguments}])}).always(function(){$(window).trigger("dna:always",[{dnaArguments:e,arguments:arguments}])}),n=function(){r.reject.apply(this,arguments)},t=dna["dna:core"].getOpts(arguments,[{recursive:!0,match:"array"},["jsonURLs",/\//],["required","string"],["settings",function(e){return $.isPlainObject(e)&&!e.proto&&!e.id}],["configs","plainObject"],["callbacks","function"]]);if(t.settings.forEach(dna["dna:core"].set),t.jsonURLs.length+t.required.length+t.configs.length==0)return dna["dna:core"].checkQueue(),r.resolve().done(t.callbacks).promise();try{t.configs.forEach(dna["dna:core"].configure.bind(dna["dna:core"])),$.when.apply(this,t.jsonURLs.map(rewriteURL).map(download)).done(function(){var e=$.makeArray(arguments).map(function(e,r){return dna["dna:core"].getOpts($.parseJSON(e),[["configs","plainObject"],"recursive"]).configs.map(function(e){return e.baseURL=t.jsonURLs[r],e})});dna(e).done(function(){dna["dna:core"].whenSatisfied(t.required).done(function(){$.when.apply(this,t.required.map(function(e){return dna["dna:core"].require(e)})).done(t.callbacks,function(){r.resolve.apply(this,arguments)}).fail(n)}).fail(n)}).fail(n)}).fail(n)}catch(e){r.reject(new DNAError(e))}return r.promise()};dna.push=function(){return dna.apply(this,arguments),dna["dna:core"].queue.length},DNACore.prototype.version="1.0",DNACore.prototype.queue=null,DNACore.prototype.configs=null,DNACore.prototype.resources=null,DNACore.prototype.resolveURL=function(){for(var e=document.implementation.createHTMLDocument("html","",""),r=e.head.appendChild(e.createElement("base")),n=e.body.appendChild(e.createElement("a")),t=location?location.href:"https://no-location-href.example.com/",i=arguments.length-1;i>=0;i--)"string"==typeof arguments[i]&&arguments[i].length&&(r.setAttribute("href",t),n.setAttribute("href",arguments[i]),t=n.href);return t},DNACore.prototype.set=function(e){$.each(e,function(e,r){switch(e){case"factory":delete r.dna,settings[e]=$.extend(settings[e],r);break;case"fetcher":delete r["*"],settings[e]=$.extend(settings[e],r);break;case"rewrite":settings[e]=settings[e].concat(r);break;default:settings[e]=r}}),console.log("DNA: Settings altered.",settings)},DNACore.prototype.configure=function(e){var r=!1;e=$.extend({},e),e.id&&(r=validateString(e.id,/^[a-zA-Z0-9_:@#$*.-]+$/i,"Invalid `id` name in "+JSON.stringify(e)+".")),e.service&&(r=validateString(e.service,/^[a-zA-Z0-9_:@#$*.-]*$/,"Invalid `service` name in "+JSON.stringify(e)+".")),e.proto&&(r=validateString(e.proto,/^[A-Z][a-zA-Z0-9_]*(=[a-zA-Z0-9_:@#$*.-]+)*$/,"Invalid `proto` name in "+JSON.stringify(e)+".")),r||$.error("At least one must be specified `id` or `service` or `proto` in Config "+JSON.stringify(e)),e.service&&!e.proto&&$.error('Service "'+e.service+'" requires the `proto` property: '+JSON.stringify(e)),cleanConfigFast(e),[e.id,e.service].concat(e.proto.slice(e.proto.length>1?1:0)).forEach(function(r){r&&("undefined"==typeof dna[r]?dna[r]=null:$.error("DNA: Conflicting name `"+r+"` / redundand Config registration while registering config: "+JSON.stringify(e)+"; conflicting config exists: "+JSON.stringify(dna["dna:core"].getConfig(r))+". Note: All `id`, `proto` and `service` names must be unique accross the board."))}),this.configs.push(e)},DNACore.prototype.canSatisfy=function(e,r){if("undefined"==typeof e||0==e.length)return!0;r=r||[];for(var n in e){if(-1!==$.inArray(e[n],r))throw new DNAError("DNA: Recursive requirement loop: "+r.join(" > ")+" > "+e[n],601,{requirements:e,stack:r});var t=this.getConfig(e[n]);if(!t)return!1;if(t.eval&&!settings.factory[t.eval])return!1;var i=r.slice();if(i.push(e[n]),!this.canSatisfy(t.require,i))return!1}return!0},DNACore.prototype.whenSatisfied=function(){var e=$.Deferred(),r=dna["dna:core"].getOpts(arguments,[["requirements","string"],["callbacks","function"],"recursive"]);return r._dfd=e,this.queue.push(r),this.checkQueue(),e},DNACore.prototype.checkQueue=function(){for(var e=this.queue.length-1;e>=0;e--){var r=this.queue[e];try{var n=this.canSatisfy(r.requirements)}catch(n){this.queue.splice(e,1),r._dfd.reject(new DNAError(n));break}n?(this.queue.splice(e,1),$(r.callbacks).each(function(e,r){r()}),r._dfd.resolve(r)):console.log("DNA: Queued action #"+(e+1)+"/"+this.queue.length+": Waiting for yet undefined requirements: "+r.requirements.join(", "))}},DNACore.prototype.getConfig=function(e){for(var r=0;r<this.configs.length;r++){var n=this.configs[r];if(n.id==e||n.service==e||-1!==$.inArray(e,n.proto,n.proto.length>1?1:0))return readyConfig(n)}return null},DNACore.prototype.getOpts=function(e,r){var n={};return r.forEach(function(e,t){"recursive"==r[t]&&(r[t]={match:"*",recursive:!0}),$.isArray(r[t])&&(r[t]={name:r[t][0],match:r[t][1]}),"object"!=typeof r[t]&&$.error("Capture item must be of type object or array."),$.isArray(r[t].match)||(r[t].match=[r[t].match]),r[t].recursive||(n[r[t].name]=[])}),$.each($.makeArray(e),function(e,t){getOptsCategorize(t,r,n)||$.error("Unexpected opt ("+typeof t+") "+t)}.bind(this)),n},DNACore.prototype.require=function(){return requireMulti.call(this,$.makeArray(arguments),[])},DNAError.prototype=Object.create(Error.prototype),DNAError.prototype.constructor=DNAError,dna["dna:core"]=new DNACore,dna["dna:namespaces"]={},console.log("DNA: Ready.");var initQueue=window.dna||[];window.dna=dna;for(var i=0;i<initQueue.length;i++)window.dna.apply(this,[initQueue[i]])}(jQuery,window);
//# sourceMappingURL=./dna.min.map