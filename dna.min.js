/**
 * Javascript DNA 1.0
 *
 * Minimalistic asynchronous script loader, dependency resolver and
 * framework base. No bullshits.
 *
 * @license The MIT License (MIT), https://github.com/webdevelopers-eu/javascript-dna
 * @preserve Copyright (c) 2016 Daniel Ševčík, www.webdevelopers.eu
 */
"use strict";if("function"!=typeof jQuery)throw new Error("DNA requires jQuery");!function($,window){function DNACore(){this.queue=[],this.configs=[],this.resources={}}function getOptsCategorize(e,r,t){var n=[$.type(e)];return $.isPlainObject(e)&&n.push("plainObject"),$.isNumeric(e)&&n.push("numeric"),$.isXMLDoc(e)&&n.push("xmlDocument"),r.some(function(o,i){var a=r[i].match.some(function(r){return getOptsMatch(e,r,n)},this);return a?(r[i].recursive?$.isPlainObject(e)?$.each(e,function(e,r){t[e]||(t[e]=[]),t[e].push(r)}):$.each(e,function(e,n){getOptsCategorize(n,r,t)}.bind(this)):t[r[i].name].push(e),!0):!1},this)}function getOptsMatch(e,r,t){switch(typeof r){case"function":return r(e);case"object":return-1!==$.inArray("string",t)&&r.test(e);case"string":return"*"==r||-1!==$.inArray(r,t);default:$.error('Cannot parse opts. Unexpected match type "'+typeof r+'"')}return!1}function requireMulti(e,r){var t=[];try{this.getOpts(e,[["names","string"],"recursive"]).names.forEach(function(e){t.push(requireSingle.call(this,e,r))}.bind(this))}catch(e){return $.Deferred().reject(new DNAError(e)).promise()}return $.when.apply(this,t)}function requireSingle(e,r){var t,n=[],o=$.Deferred();return-1!=$.inArray(e,r)&&$.error("DNA: Recursive requirement: "+r.join(" > ")+" > "+e+" (recursion)"),r.push(e),t=dna["dna:core"].getConfig(e),t||$.error('DNA: Cannot satisfy the requirement "'+e+'"'),t._dfd?t._dfd:(t._dfd=o.promise(),n.push(this.load(t,t.load||[])),n.push(requireMulti.call(this,[t.require],r)),$.when.apply(this,n).done(function(r){var n;evaluateScripts(r).done(function(r){t.proto[0]&&(r?$.each(t.proto.slice(t.proto.length>1?1:0),function(e,t){dna[t]=r}):o.reject(new DNAError('DNA: Cannot find the Proto object window["'+t.proto+'"]: '+JSON.stringify(t),602,{config:t}))),r&&t.service&&(dna[t.service]=new r),t.id==e?n=t:dna[e]&&(n=dna[e]),n?o.resolve(n):o.reject(new DNAError('DNA: Cannot find the requested object dna["'+e+'"]: '+JSON.stringify(t),603,{config:t}))}).fail(function(){o.reject.apply(this,arguments)})}).fail(function(){o.reject.apply(this,arguments)}),t._dfd)}function evaluateScripts(e){function r(o){if(!o)return e.length?n.reject(new DNAError("Scripts queue is not empty and we got no data!",607,{script:o,queue:e})):n.resolve(t);var i=settings.factory[o.config.eval||"dna"],a=$.Deferred().done(function(n){t=n||t,r(e.shift())}).fail(function(){n.reject(new DNAError("Evaluation of the script failed.",608,{arguments:arguments,about:o}))});if("function"!=typeof i)return a.reject(new DNAError('Unknown evaluation type "'+o.config.eval+'"',604,o));try{i(a,o.jString,o.config.proto[0])}catch(e){return a.reject(new DNAError(e))}return a}var t,n=$.Deferred();return r(e.shift()),n}function loadGetResource(e){var r,t=$.Deferred(),n=e.split("#");return r=function(r){if(1==n.length)return void t.resolve(r+" //# sourceURL="+e+"#dna");var o=document.implementation.createHTMLDocument("html","","");o.childNodes[1].innerHTML=r;try{var i=$("#"+n[1],o);if(!i.length)throw'Bundled resource "#'+n[1]+'" not found in "'+e+'"'}catch(r){return void t.reject(new DNAError('Cannot extract resource "#'+n[1]+'" from bundle "'+e+": "+(r.message||r),609,r))}var a=$.trim(i.text());if(a.length)t.resolve(a+" //# sourceURL="+e);else if(i.attr("src")){var s=i.get(0).src||i.attr("src")||i.get(0).href||i.attr("href");s?loadGetResource(dna["dna:core"].resolveURL(s,e)).done(function(){t.resolve.apply(this,arguments)}).fail(function(){t.reject.apply(this,arguments)}):t.reject(new DNAError('The script "'+e+'" has no contents and no reference to other external resource.',605,{script:i.get(0),source:r,url:e}))}else t.reject(404,'Cannot load script "'+e+'"')},download(n[0]).done(r).fail(function(){t.reject.apply(this,arguments)}),t}function validateString(e,r,t){return e&&r.test(e)||$.error("DNA: "+t+" String "+JSON.stringify(e)+" does not match the pattern "+r),!0}function download(e){if(dna["dna:core"].resources[e])return dna["dna:core"].resources[e];var r=$.Deferred();dna["dna:core"].resources[e]=r.promise();var t=e.match(/^([a-z][a-z0-9+.-]*):/i)[1];return r.fail(function(e){new DNAError(e)}),(settings.fetcher[t]||defaultFetcher)(r,e)===!1&&defaultFetcher(r,e),dna["dna:core"].resources[e]}function defaultFetcher(e,r){return $.ajax({url:r,dataType:"text",cache:!0,type:"GET",async:!0,headers:{"X-Requested-With":"DNA"}}).done(function(r){e.resolve(r)}).fail(function(t,n,o){e.reject.call(this,new DNAError('Download "'+r+'" failed: '+t.status+" "+n+" "+o,606,{xhr:t,textStatus:n,error:o}))}),!0}function rewriteURL(e,r){var t=e;return settings.rewrite.forEach(function(r){e=r(e,t)||e}),e=dna["dna:core"].resolveURL(e,r)}function DNAError(e,r,t){e instanceof Error?(this.name=e.name||"DNAError",this.message=e.message||"Unknown Error.",this.code=e.code||700,this.detail=e.detail||e):(this.name="DNAError",this.message=e||"Ups!",this.code=r||700,this.detail=t),this.stack=(new Error).stack,console.log("DNAError: "+this.code+" "+e,t,this.stack)}var settings={rewrite:[],fetcher:{},factory:{window:function(e,r,t){t=t?'window["'+t+'"]':"undefined";var n="typeof "+t+" == 'undefined' ? undefined : "+t;e.resolve(function(){return window.eval(r+"\n\n/* Javascript DNA: Compat Layer */;\n"+n)}())},dna:function(dfd,jString,protoName){protoName=protoName?protoName:"undefined";var retStatement="typeof "+protoName+" == 'undefined' ? undefined : "+protoName;dfd.resolve(function(){return eval(jString+"\n\n/* Javascript DNA: Compat Layer */;\n"+retStatement)}())}}},dna=function(){var e=arguments,r=$.Deferred().done(function(){$(window).trigger("dna:done",[{dnaArguments:e,arguments:arguments}])}).fail(function(){$(window).trigger("dna:fail",[{dnaArguments:e,arguments:arguments}])}).always(function(){$(window).trigger("dna:always",[{dnaArguments:e,arguments:arguments}])}),t=function(){r.reject.apply(this,arguments)},n=dna["dna:core"].getOpts(arguments,[{recursive:!0,match:"array"},["jsonURLs",/\//],["required","string"],["settings",function(e){return $.isPlainObject(e)&&!e.proto&&!e.id}],["configs","plainObject"],["callbacks","function"]]);if(n.settings.forEach(dna["dna:core"].set),n.jsonURLs.length+n.required.length+n.configs.length==0)return dna["dna:core"].checkQueue(),r.resolve().done(n.callbacks).promise();try{n.configs.forEach(dna["dna:core"].configure.bind(dna["dna:core"])),$.when.apply(this,n.jsonURLs.map(rewriteURL).map(download)).done(function(){var e=$.makeArray(arguments).map(function(e,r){return dna["dna:core"].getOpts($.parseJSON(e),[["configs","plainObject"],"recursive"]).configs.map(function(e){return e.baseURL=n.jsonURLs[r],e})});dna(e).done(function(){dna["dna:core"].whenSatisfied(n.required).done(function(){$.when.apply(this,n.required.map(function(e){return dna["dna:core"].require(e)})).done(n.callbacks,function(){r.resolve.apply(this,arguments)}).fail(t)}).fail(t)}).fail(t)}).fail(t)}catch(e){r.reject(new DNAError(e))}return r.promise()};dna.push=function(){return dna.apply(this,arguments),dna["dna:core"].queue.length},DNACore.prototype.version="1.0",DNACore.prototype.queue=null,DNACore.prototype.configs=null,DNACore.prototype.resources=null,DNACore.prototype.resolveURL=function(){for(var e=document.implementation.createHTMLDocument("html","",""),r=e.head.appendChild(e.createElement("base")),t=e.body.appendChild(e.createElement("a")),n=location?location.href:"https://no-location-href.example.com/",o=arguments.length-1;o>=0;o--)"string"==typeof arguments[o]&&arguments[o].length&&(r.setAttribute("href",n),t.setAttribute("href",arguments[o]),n=t.href);return n},DNACore.prototype.set=function(e){$.each(e,function(e,r){switch(e){case"factory":delete r.dna,delete r.window;case"fetcher":settings[e]=$.extend(settings[e],r);break;case"rewrite":settings[e]=settings[e].concat(r);break;default:settings[e]=r}}),console.log("DNA: Settings altered.",settings)},DNACore.prototype.configure=function(e){var r=!1;e=$.extend({},e),e.id&&(r=validateString(e.id,/^[a-zA-Z0-9_:@#$*.-]+$/i,"Invalid `id` name in "+JSON.stringify(e)+".")),e.service&&(r=validateString(e.service,/^[a-zA-Z0-9_:@#$*.-]*$/,"Invalid `service` name in "+JSON.stringify(e)+".")),e.proto&&(r=validateString(e.proto,/^[A-Z][a-zA-Z0-9_]*(=[a-zA-Z0-9_:@#$*.-]+)*$/,"Invalid `proto` name in "+JSON.stringify(e)+".")),r||$.error("At least one must be specified `id` or `service` or `proto` in Config "+JSON.stringify(e)),e.service&&!e.proto&&$.error('Service "'+e.service+'" requires the `proto` property: '+JSON.stringify(e)),delete e._dfd,e.proto=e.proto?e.proto.split("="):[],[e.id,e.service].concat(e.proto.slice(e.proto.length>1?1:0)).forEach(function(r){r&&("undefined"==typeof dna[r]?dna[r]=null:$.error("DNA: Conflicting name `"+r+"` / redundand Config registration while registering config: "+JSON.stringify(e)+"; conflicting config exists: "+JSON.stringify(dna["dna:core"].getConfig(r))+". Note: All `id`, `proto` and `service` names must be unique accross the board."))}),this.configs.push(e)},DNACore.prototype.canSatisfy=function(e,r){if("undefined"==typeof e||0==e.length)return!0;r=r||[];for(var t in e){if(-1!==$.inArray(e[t],r))throw new DNAError("DNA: Recursive requirement loop: "+r.join(" > ")+" > "+e[t],601,{requirements:e,stack:r});var n=this.getConfig(e[t]);if(!n)return!1;if(n.eval&&!settings.factory[n.eval])return!1;var o=r.slice();if(o.push(e[t]),!this.canSatisfy(n.require,o))return!1}return!0},DNACore.prototype.whenSatisfied=function(){var e=$.Deferred(),r=this.getOpts(arguments,[["requirements","string"],["callbacks","function"],"recursive"]);return r._dfd=e,this.queue.push(r),this.checkQueue(),e},DNACore.prototype.checkQueue=function(){for(var e=this.queue.length-1;e>=0;e--){var r=this.queue[e];try{var t=this.canSatisfy(r.requirements)}catch(t){this.queue.splice(e,1),r._dfd.reject(new DNAError(t));break}t?(this.queue.splice(e,1),$(r.callbacks).each(function(e,r){r()}),r._dfd.resolve(r)):console.log("DNA: Queued action #"+(e+1)+"/"+this.queue.length+": Waiting for yet undefined requirements: "+r.requirements.join(", "))}},DNACore.prototype.getConfig=function(e){for(var r=0;r<this.configs.length;r++){var t=this.configs[r];if(t.id==e||t.service==e||-1!==$.inArray(e,t.proto,t.proto.length>1?1:0))return t._clean||(t.load=dna["dna:core"].getOpts(t.load,[["urls","string"],"recursive"]).urls.map(function(e){return rewriteURL(e,t.baseURL)}),"string"==$.type(t.require)&&(t.require=[t.require]),"string"==$.type(t.load)&&(t.load=[t.load]),t._clean=!0),t}return null},DNACore.prototype.getOpts=function(e,r){var t={};return r.forEach(function(e,n){"recursive"==r[n]&&(r[n]={match:"*",recursive:!0}),$.isArray(r[n])&&(r[n]={name:r[n][0],match:r[n][1]}),"object"!=typeof r[n]&&$.error("Capture item must be of type object or array."),$.isArray(r[n].match)||(r[n].match=[r[n].match]),r[n].recursive||(t[r[n].name]=[])}),$.each($.makeArray(e),function(e,n){getOptsCategorize(n,r,t)||$.error("Unexpected opt ("+typeof n+") "+n)}.bind(this)),t},DNACore.prototype.require=function(){return requireMulti.call(this,$.makeArray(arguments),[])},DNACore.prototype.load=function(e,r){r=this.getOpts(r,[["urls","string"],"recursive"]).urls;var t=[];r.forEach(function(e){t.push(loadGetResource(e))});var n=$.Deferred();return $.when.apply(this,t).done(function(){for(var r=[],t=0;t<arguments.length;t++)r.push({jString:arguments[t],config:e});n.resolve(r)}).fail(function(){n.reject.apply(this,arguments)}),n},DNAError.prototype=Object.create(Error.prototype),DNAError.prototype.constructor=DNAError,dna.DNACore=DNACore,dna["dna:core"]=new DNACore,console.log("DNA: Ready.");var initQueue=window.dna||[];window.dna=dna;for(var i=0;i<initQueue.length;i++)window.dna.apply(this,[initQueue[i]])}(jQuery,window);
//# sourceMappingURL=./dna.min.map